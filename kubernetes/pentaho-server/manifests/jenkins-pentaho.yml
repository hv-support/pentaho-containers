// Uses Declarative syntax to run commands inside a container.
pipeline {
    agent none
    stages {
        stage('prepare') {
            matrix {
                agent {
                    kubernetes {
                        defaultContainer 'pentaho-server'
                        yaml """
apiVersion: v1
kind: Pod
metadata:
  name: pentaho-server
spec:
  volumes:
  - name: key
    secret:
      secretName: key
  - name: pentaho-license
    secret:
      secretName: pentaho-license
  - name: init-databases-volume
    configMap:
      name: init-db-scripts
  containers:
  - name: postgres
    image: postgres:9.5
    imagePullPolicy: 'Always'
    ports:
      - containerPort: 5432
    env:
      - name: POSTGRES_PASSWORD
        value: password
      - name: PGDATA
        value: /var/lib/postgresql/data/pgdata
    ports:
      - containerPort: 5432
        name: postgresql
        protocol: TCP
    resources:
      requests:
      memory: '2Gi'
      cpu: '1'
    volumeMounts:
      - name: init-databases-volume
        mountPath: /docker-entrypoint-initdb.d
  - name: pentaho-server
    image: gcr.io/pentaho-support-team/pentaho/pentaho-server-gke:latest
    imagePullPolicy: 'Always'
    resources:
      limits:
        memory: '4500Mi'
    requests:
        memory: '2000Mi'
    ports:
      - containerPort: 8080
    volumeMounts:
      - name: key
        mountPath: '/secrets/key'
      - name: pentaho-license
        mountPath: '/secrets/pentahoLicense'
    env:
      - name: GCS_PENTAHO_CONFIG_PATH
        value: 'gs://support-emea-hv/pentaho-gke/psql12-config'
      - name: PENTAHO_INSTALLATION_PATH
        value: '/opt/pentaho/pentaho-server'
      - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
        value: '/secrets/key/key.json'
      - name: GOOGLE_APPLICATION_CREDENTIALS
        value: '/secrets/key/key.json'
      - name: PENTAHO_INSTALLED_LICENSE_PATH
        value: '/secrets/pentahoLicense/.installedLicenses.xml'
      - name: CATALINA_OPTS
        value: '-Dpentaho.installed.licenses.file=/secrets/pentahoLicense/.installedLicenses.xml -XX:+UnlockExperimentalVMOptions -XX:+UseContainerSupport -XX:+UseCGroupMemoryLimitForHeap -Dfile.encoding=utf8 -XX:MaxRAMPercentage=80.0 -XX:MinHeapFreeRatio=10 -XX:MaxHeapFreeRatio=20 -XX:+ExitOnOutOfMemoryError -XX:+UseG1GC'                
    args: ['/opt/pentaho/pentaho-server/tomcat/bin/catalina.sh','run']
                            """
                    }
                }
                axes {
                    axis {
                        name 'IMAGE'
                        values 'ubuntu', 'centos'
                    }
                    axis {
                        name 'TEST'
                        values '1', '2'
                    }
                }
                stages {
                    stage('Main') {
                        steps {
                            echo "Do Build for ${IMAGE} - ${TEST}"
                            sh 'hostname'
                        }
                    }
                }
            }
        }
    }
}
